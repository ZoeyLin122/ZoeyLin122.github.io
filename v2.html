<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç©è½‰æƒ…ç·’å­¸ç¿’å¹³å°</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body {
            background-color: #fff4e3;
            font-family: "Noto Sans TC", "Microsoft JhengHei", "PingFang TC", sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* --- äº’å‹•æ•ˆæœ --- */
        .nav-shadow {
            box-shadow: 0 4px 20px rgba(230, 145, 56, 0.1);
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }
        
        .card-hover:active {
            transform: scale(0.98);
        }

        /* --- æ—¥æ›†æ¨£å¼ --- */
        .calendar-day {
            aspect-ratio: 1;
            transition: all 0.2s;
            border-radius: 0.75rem;
            color: #7c2d12;
            position: relative;
            overflow: hidden;
        }
        
        .calendar-day:hover:not(.empty) {
            background-color: #fff7ed;
            cursor: pointer;
            color: #ea580c;
            font-weight: bold;
            box-shadow: inset 0 0 0 2px #fdba74;
        }
        
        .calendar-day:active:not(.empty) {
            background-color: #fed7aa;
        }

        /* --- UI å…ƒä»¶æ¨£å¼ --- */
        .writing-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        .example-chip { 
            background-color: #f3f4f6; 
            color: #4b5563; 
            transition: all 0.2s;
            cursor: pointer;
            text-align: left;
            border: 1px solid transparent;
        }
        
        .example-chip:hover { 
            background-color: #ffedd5; 
            color: #c2410c; 
            border-color: #fdba74;
        }
        
        .example-chip:active { 
            transform: scale(0.98); 
        }
        
        .tab-btn { 
            transition: all 0.2s; 
            border-bottom: 3px solid transparent; 
        }
        
        .tab-btn.active { 
            color: #ea580c; 
            border-bottom-color: #ea580c; 
            font-weight: bold; 
        }

        /* --- è¦–åœ–æ§åˆ¶ --- */
        .hidden-view { 
            display: none !important; 
        }
        
        .fade-in { 
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- ç‰¹æ®Šå€å¡Š --- */
        .summary-box { 
            background-color: #fff7ed; 
            border-left: 4px solid #f97316; 
            padding: 1.25rem; 
            border-radius: 0.5rem; 
        }
        
        .image-placeholder { 
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E"); 
        }
        
        .modal-overlay { 
            background-color: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(4px); 
        }

        /* --- å‹•ç•«ç‰¹æ•ˆ --- */
        @keyframes heart-beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .like-active svg { 
            fill: #ef4444; 
            stroke: #ef4444; 
            animation: heart-beat 0.4s ease-in-out; 
        }

        .points-pop {
            animation: pop 0.3s ease-out;
        }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }

        /* --- å‹³ç« èˆ‡æŒ‘æˆ°æ¨£å¼ --- */
        .badge-locked {
            filter: grayscale(100%);
            opacity: 0.6;
        }
        .badge-card {
            transition: transform 0.2s;
        }
        .badge-card:hover {
            transform: translateY(-5px);
        }
        .challenge-step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            position: relative;
            z-index: 10;
        }
        .challenge-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #e5e7eb;
            transform: translateY(-50%);
            z-index: 0;
        }
        .challenge-progress {
            height: 100%;
            background-color: #f97316;
            transition: width 1s ease-out;
        }
        /* å•†åº—å¡ç‰‡ */
        .shop-card {
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .shop-card:hover {
            border-color: #fdba74;
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .btn-buy:active {
            transform: scale(0.95);
        }
        
        /* å•†åº—åˆ†é¡ Tab */
        .shop-tab {
            padding: 6px 12px; /* Smaller padding for mobile */
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .shop-tab.active {
            background-color: #f97316;
            color: white;
            box-shadow: 0 2px 4px rgba(249, 115, 22, 0.3);
        }
        .shop-tab.inactive {
            background-color: white;
            color: #6b7280;
            border-color: #e5e7eb;
        }
        .shop-tab.inactive:hover {
            border-color: #f97316;
            color: #f97316;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* è§’è‰² Avatar å‹•ç•« */
        .avatar-bounce {
            animation: avatarBounce 0.5s ease-out;
        }
        @keyframes avatarBounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .item-appear {
            animation: itemFadeIn 0.5s ease-out;
        }
        @keyframes itemFadeIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        .pet-float {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        
        /* é€²åº¦æ¢å‹•ç•« */
        .progress-bar-fill {
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* æ’è¡Œæ¦œæ¨£å¼ */
        .rank-item {
            transition: all 0.2s;
        }
        .rank-item:hover {
            transform: scale(1.01);
            background-color: #fffaf0;
        }
        .rank-badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .rank-1 { background-color: #fbbf24; color: #78350f; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .rank-2 { background-color: #94a3b8; color: white; }
        .rank-3 { background-color: #b45309; color: white; }
        .rank-other { background-color: #e5e7eb; color: #6b7280; }

        /* å‹³ç« è§£é– Modal å‹•ç•« */
        .badge-pop-enter {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }
        .shine-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            transform: translate(-50%, -50%) rotate(0deg);
            animation: spin 10s linear infinite;
            z-index: 0;
            pointer-events: none;
        }
        @keyframes spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <!-- å°èˆªæ¬„ -->
    <nav class="bg-white px-4 md:px-8 py-3 flex flex-col md:flex-row justify-between items-center nav-shadow sticky top-0 z-50">
        <!-- Brand -->
        <div class="w-full md:w-auto flex justify-between items-center mb-2 md:mb-0">
            <div class="text-xl md:text-2xl font-bold text-orange-600 cursor-pointer flex items-center gap-2" onclick="navigate('home')">
            
                <div class="flex h-10 w-30 overflow-hidden">
                    <img src="https://i.ibb.co/Z1YkSdkd/14.png" class="w-auto h-full object-contain">
                    <img src="https://i.ibb.co/mVdK4Ghb/10.png" class="w-auto h-full object-contain">
                    <img src="https://i.ibb.co/xPfGsXb/12.png" class="w-auto h-full object-contain">
                </div>

                <span class="object-contain">ç©è½‰æƒ…ç·’å­¸ç¿’å¹³å°</span>
                <div class="flex h-10 w-30 overflow-hidden">  
                    <img src="https://i.ibb.co/DfZhznB6/13.png" class="w-full h-full object-contain">
                    <img src="https://i.ibb.co/HLVvK52X/9.png" class="w-full h-full object-contain">
                    <img src="https://i.ibb.co/sJC5MmBd/11.png" class="w-full h-full object-contain">
             </div>
            </div>
        </div>

        <!-- Right Menu -->
        <div class="w-full md:w-auto flex justify-end items-center space-x-4 md:space-x-6 text-gray-700 font-medium text-sm md:text-base">
            <!-- æ’è¡Œæ¦œæŒ‰éˆ• (åœ“è§’é•·æ–¹å½¢ + Icon) -->
            <button onclick="navigate('leaderboard')" class="bg-orange-50 text-orange-800 px-3 py-1.5 rounded-full text-sm font-bold flex items-center gap-2 shadow-inner border border-orange-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                æ’è¡Œæ¦œ
            </button>

            <!-- ä½¿ç”¨è€…è³‡è¨Šå€ (ä¿®æ”¹ç‚ºå¯é»æ“Š) -->
            <div class="flex items-center space-x-3 border-l pl-4 md:pl-6 border-gray-200 cursor-pointer group" onclick="navigate('profile')" title="æŸ¥çœ‹å€‹äººæª”æ¡ˆèˆ‡æˆå°±">
                <span class="bg-orange-50 group-hover:bg-orange-100 transition-colors text-orange-800 px-3 py-1.5 rounded-full text-sm font-bold flex items-center gap-2 shadow-inner border border-orange-100">
                    å°æ˜ 
                    <span class="bg-yellow-400 text-yellow-900 text-xs px-2 py-0.5 rounded-full ml-1" id="user-points-display">ğŸª™ 0</span>
                </span>
                
                <!-- ç™»å‡º Icon -->
                <button id="logoutBtn" onclick="event.stopPropagation(); showToast('æ‚¨å·²æˆåŠŸç™»å‡º')" class="text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50" title="ç™»å‡º">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app-container" class="flex-grow flex flex-col relative">
        
        <!-- 1. é¦–é  View -->
        <main id="view-home" class="flex-grow flex items-center justify-center px-4 py-8 md:py-12 fade-in">
            <div class="max-w-6xl w-full grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8">
                
                <!-- å¡ç‰‡: æƒ…ç·’æ—¥è¨˜ -->
                <div onclick="navigate('calendar')" class="bg-white rounded-3xl p-8 flex flex-col items-center justify-center cursor-pointer card-hover border-2 border-transparent hover:border-orange-200 shadow-sm group">
                    <div class="w-20 h-20 bg-orange-100 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300">
                        <div class="h-full overflow-hidden"> <img src="https://i.ibb.co/93NQdRSK/5.png" class="w-full h-full object-cover"></div>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 group-hover:text-orange-600 transition-colors">æƒ…ç·’æ—¥è¨˜</h2>
                    <p class="text-gray-500 text-center">ç´€éŒ„ä»Šå¤©çš„æ„Ÿå—ï¼Œèˆ‡è‡ªå·±å°è©±</p>
                </div>

                <!-- å¡ç‰‡: å…±æ„Ÿç•«å¸ƒ -->
                <div onclick="navigate('canvas')" class="bg-white rounded-3xl p-8 flex flex-col items-center justify-center cursor-pointer card-hover border-2 border-transparent hover:border-blue-200 shadow-sm group">
                    <div class="w-20 h-20 bg-blue-100 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300">
                        <div class="h-full overflow-hidden"> <img src="https://i.ibb.co/39BhRqsy/6.png" class="w-full h-full object-cover"></div>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 group-hover:text-blue-600 transition-colors">å…±æ„Ÿç•«å¸ƒ</h2>
                    <p class="text-gray-500 text-center">ç·´ç¿’çµ¦äºˆæº«æš–çš„æ­£å‘æ”¯æŒ</p>
                </div>

                <!-- å¡ç‰‡: æ¡ˆä¾‹æ¢è¨ -->
                <div class="bg-white rounded-3xl p-8 flex flex-col items-center justify-center cursor-pointer card-hover border-2 border-transparent hover:border-red-200 shadow-sm group">
                    <div class="w-20 h-20 bg-red-100 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300">
                        <div class="h-full overflow-hidden"> <img src="https://i.ibb.co/N6bhYRc9/8.png" class="w-full h-full object-cover"></div>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 group-hover:text-red-600 transition-colors">æ¡ˆä¾‹æ¢è¨</h2>
                    <p class="text-gray-500 text-center">æ ¹æ“šæ•…äº‹æƒ…å¢ƒä¾†é€²è¡Œéæš´åŠ›æºé€šç·´ç¿’</p>
                </div>

            </div>
        </main>

        <!-- 2. æ—¥æ›† View -->
        <main id="view-calendar" class="hidden-view flex-grow flex flex-col items-center px-4 py-6 md:py-8 fade-in">
            <div class="max-w-4xl w-full bg-white rounded-3xl shadow-sm p-4 md:p-8">
                <div class="flex flex-col-reverse md:flex-row items-center justify-between mb-6 md:mb-8 relative">
                    <button onclick="navigate('home')" class="self-start md:self-center flex items-center text-gray-500 hover:text-orange-600 transition-colors mt-4 md:mt-0 z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        <span class="text-sm md:text-base">è¿”å›é¦–é </span>
                    </button>
                    
                    <div class="flex items-center justify-center w-full md:absolute md:left-0 md:right-0 pointer-events-none">
                        <button onclick="changeMonth(-1)" class="pointer-events-auto p-2 hover:bg-gray-100 rounded-full text-gray-400 hover:text-orange-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <h2 id="calendar-title" class="text-2xl md:text-3xl font-bold text-gray-800 mx-4 w-40 text-center"></h2>
                        <button onclick="changeMonth(1)" class="pointer-events-auto p-2 hover:bg-gray-100 rounded-full text-gray-400 hover:text-orange-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                    <div class="hidden md:block w-20"></div> 
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 md:gap-4 text-center"></div>
            </div>
        </main>

        <!-- 3. æ—¥è¨˜åˆ—è¡¨ View -->
        <main id="view-day-list" class="hidden-view flex-grow flex flex-col items-center px-4 py-6 md:py-8 fade-in">
            <div class="max-w-2xl w-full flex flex-col h-full">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="navigate('calendar')" class="flex items-center text-gray-500 hover:text-orange-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        è¿”å›æ—¥æ›†
                    </button>
                    <h2 id="day-list-title" class="text-2xl font-bold text-gray-800"></h2>
                    <div class="w-20"></div> 
                </div>
                <div id="entries-container" class="space-y-4 mb-8"></div>
                <button onclick="startWriting()" class="w-full py-4 rounded-xl border-2 border-dashed border-orange-300 text-orange-500 font-bold hover:bg-orange-50 hover:border-orange-400 transition-all flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    æ–°å¢æ—¥è¨˜
                </button>
            </div>
        </main>

        <!-- 4-7. å¯«ä½œæ­¥é©Ÿ Views (åˆä½µé‚è¼¯) -->
        <!-- Step 1: è§€å¯Ÿ -->
        <main id="view-step-1" class="hidden-view flex-grow flex flex-col items-center px-4 py-6 md:py-8 fade-in">
            <div class="max-w-2xl w-full writing-card p-6 md:p-10 flex flex-col h-full">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-orange-600">æ­¥é©Ÿ 1/4ï¼šè§€å¯Ÿ</h3><span class="date-display text-gray-400 text-sm"></span></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">è§€å¯Ÿï½œä½ ä»Šå¤©ç™¼ç”Ÿä»€éº¼äº‹æƒ…ï¼Ÿ</h2>
                <textarea id="input-obs" class="w-full h-32 p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-300 focus:border-orange-500 outline-none resize-none mb-6" placeholder="è«‹è¼¸å…¥..."></textarea>
                <div class="mb-6"><p class="text-sm text-gray-500 mb-3 font-bold">åƒè€ƒç¯„ä¾‹</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2" id="obs-examples"></div>
                </div>
                <div class="mt-auto flex justify-between pt-4 border-t border-gray-100">
                    <button onclick="navigate('day-list')" class="px-6 py-2 text-gray-500 hover:text-gray-800">å–æ¶ˆ</button>
                    <button onclick="navigate('step-2')" class="px-8 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-full font-bold shadow-md transition-all">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </main>

        <!-- Step 2: æ„Ÿå— -->
        <main id="view-step-2" class="hidden-view flex-grow flex flex-col items-center px-4 py-6 md:py-8 fade-in">
            <div class="max-w-2xl w-full writing-card p-6 md:p-10 flex flex-col h-full">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-orange-600">æ­¥é©Ÿ 2/4ï¼šæ„Ÿå—</h3><span class="date-display text-gray-400 text-sm"></span></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">æ„Ÿå—ï½œä½ çš„æ„Ÿå—æ˜¯ä»€éº¼ï¼Ÿ</h2>
                <div class="h-full overflow-hidden"> <img src="https://i.ibb.co/WvvPjz8M/2.png" class="w-full h-full object-cover"></div>
                <br>
                <p class="text-black-500 mb-4">é‡å°ä»Šå¤©ç™¼ç”Ÿçš„äº‹æƒ…ï¼Œä½ çš„æ„Ÿå—æ˜¯ä»€éº¼ï¼Ÿ</p>
                <textarea id="input-feel" class="w-full h-48 p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-300 focus:border-orange-500 outline-none resize-none mb-6" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ„Ÿåˆ°å¾ˆé–‹å¿ƒã€ç„¦æ…®ã€èˆˆå¥®..."></textarea>
                <div class="mt-auto flex justify-between pt-4 border-t border-gray-100">
                    <button onclick="navigate('step-1')" class="px-6 py-2 text-gray-500 hover:text-gray-800">ä¸Šä¸€æ­¥</button>
                    <button onclick="navigate('step-3')" class="px-8 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-full font-bold shadow-md transition-all">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </main>

        <!-- Step 3: éœ€è¦ -->
        <main id="view-step-3" class="hidden-view flex-grow flex flex-col items-center px-4 py-6 md:py-8 fade-in">
            <div class="max-w-2xl w-full writing-card p-6 md:p-10 flex flex-col h-full">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-orange-600">æ­¥é©Ÿ 3/4ï¼šéœ€è¦</h3><span class="date-display text-gray-400 text-sm"></span></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">éœ€è¦ï½œæˆ‘æœƒæœ‰å‰›å‰›é‚£äº›æ„Ÿå—ï¼Œæ˜¯å› ç‚º...</h2>
                <div class="w-full h-full overflow-hidden">
                        <img class="w-full h-full object-cover object-center" src="https://i.ibb.co/bg7J0yTQ/3.png">
                </div>
                <br>
                <p class="text-black-500 mb-4">é‡å°ä½ çš„æ„Ÿå—èƒŒå¾Œéœ€è¦æ˜¯ä»€éº¼ï¼Ÿ</p>
                <textarea id="input-need" class="w-full h-48 p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-300 focus:border-orange-500 outline-none resize-none mb-6" placeholder="ä¾‹å¦‚ï¼šæˆ‘éœ€è¦è¢«å°Šé‡ã€æˆ‘é‡è¦–æˆ‘å€‘çš„å‹èª¼..."></textarea>
                <div class="mt-auto flex justify-between pt-4 border-t border-gray-100">
                    <button onclick="navigate('step-2')" class="px-6 py-2 text-gray-500 hover:text-gray-800">ä¸Šä¸€æ­¥</button>
                    <button onclick="navigate('step-4')" class="px-8 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-full font-bold shadow-md transition-all">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </main>

        <!-- Step 4: è«‹æ±‚ -->
        <main id="view-step-4" class="hidden-view flex-grow flex flex-col items-center px-4 py-6 md:py-8 fade-in">
            <div class="max-w-2xl w-full writing-card p-6 md:p-10 flex flex-col h-full">
                <div class="flex justify-between items-center mb-6"><h3 class="text-lg font-bold text-orange-600">æ­¥é©Ÿ 4/4ï¼šè«‹æ±‚</h3><span class="date-display text-gray-400 text-sm"></span></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">è«‹æ±‚ï½œæˆ‘æ±ºå®šæ¡å–çš„å…·é«”è¡Œå‹•æ˜¯â€¦â€¦</h2>
                <textarea id="input-req" class="w-full h-32 p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-300 focus:border-orange-500 outline-none resize-none mb-4" placeholder="å…·é«”è¡Œå‹•..."></textarea>
                <div class="mb-4">
                    <p class="text-sm text-gray-500 mb-2 font-bold">åƒè€ƒç¯„ä¾‹</p>
                    <div class="flex space-x-4 border-b border-gray-200">
                        <button onclick="switchTab('encourage')" id="tab-encourage" class="tab-btn active pb-2 px-1 text-sm md:text-base font-medium">é¼“èˆè‡ªå·±</button>
                        <button onclick="switchTab('communicate')" id="tab-communicate" class="tab-btn pb-2 px-1 text-sm md:text-base font-medium text-gray-500">è·Ÿå°æ–¹æºé€š</button>
                        <button onclick="switchTab('celebrate')" id="tab-celebrate" class="tab-btn pb-2 px-1 text-sm md:text-base font-medium text-gray-500">æ…¶ç¥å¥½å¿ƒæƒ…</button>
                    </div>
                </div>
                <div id="content-encourage" class="mb-6 space-y-2 req-tab-content"></div>
                <div id="content-communicate" class="hidden-view mb-6 space-y-2 req-tab-content"></div>
                <div id="content-celebrate" class="hidden-view mb-6 space-y-2 req-tab-content"></div>
                <div class="mt-auto flex justify-between pt-4 border-t border-gray-100">
                    <button onclick="navigate('step-3')" class="px-6 py-2 text-gray-500 hover:text-gray-800">ä¸Šä¸€æ­¥</button>
                    <button onclick="showPreview()" class="px-8 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-full font-bold shadow-md transition-all">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </main>

        <!-- 8. é è¦½ View -->
        <main id="view-preview" class="hidden-view flex-grow flex flex-col items-center px-4 py-6 md:py-8 fade-in">
            <div class="max-w-6xl w-full bg-white rounded-3xl shadow-sm p-6 md:p-8">
                <div class="flex items-center justify-between mb-6 border-b border-gray-100 pb-4">
                    <h2 class="text-2xl font-bold text-gray-800">æ—¥è¨˜é è¦½èˆ‡å‰µä½œ</h2>
                    <span id="date-display-preview" class="text-orange-600 font-bold bg-orange-100 px-3 py-1 rounded-full text-sm"></span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- å·¦å´ -->
                    <div class="space-y-4">
                        <div class="summary-box"><h4 class="text-orange-600 font-bold mb-1 flex items-center"><span class="bg-orange-200 text-orange-700 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">1</span>è§€å¯Ÿ</h4><p id="preview-obs" class="text-gray-700 whitespace-pre-wrap pl-8"></p></div>
                        <div class="summary-box"><h4 class="text-orange-600 font-bold mb-1 flex items-center"><span class="bg-orange-200 text-orange-700 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">2</span>æ„Ÿå—</h4><p id="preview-feel" class="text-gray-700 whitespace-pre-wrap pl-8"></p></div>
                        <div class="summary-box"><h4 class="text-orange-600 font-bold mb-1 flex items-center"><span class="bg-orange-200 text-orange-700 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">3</span>éœ€è¦</h4><p id="preview-need" class="text-gray-700 whitespace-pre-wrap pl-8"></p></div>
                        <div class="summary-box"><h4 class="text-orange-600 font-bold mb-1 flex items-center"><span class="bg-orange-200 text-orange-700 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">4</span>è«‹æ±‚</h4><p id="preview-req" class="text-gray-700 whitespace-pre-wrap pl-8"></p></div>
                    </div>
                    <!-- å³å´ -->
                    <div class="flex flex-col bg-gray-50 rounded-2xl p-6 border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ç‚ºé€™ç¯‡æ—¥è¨˜é…ä¸€å¼µåœ–</h3>
                        <div id="image-control-tabs" class="flex space-x-2 mb-4 bg-white p-1 rounded-lg border border-gray-200 inline-flex self-start">
                            <button onclick="toggleImageMode('upload')" id="btn-mode-upload" class="px-4 py-2 rounded-md text-sm font-bold bg-orange-100 text-orange-600 transition-all">ä¸Šå‚³ç›¸ç‰‡</button>
                            <button onclick="toggleImageMode('ai')" id="btn-mode-ai" class="px-4 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-orange-600 transition-all">AI ç”Ÿæˆ (Gemini)</button>
                        </div>
                        <div id="image-display-area" class="w-full aspect-video bg-gray-200 rounded-xl mb-4 flex items-center justify-center overflow-hidden relative image-placeholder border-2 border-dashed border-gray-300">
                            <p id="placeholder-text" class="text-gray-400 text-sm">å°šæœªé¸æ“‡æˆ–ç”Ÿæˆåœ–ç‰‡</p>
                            <img id="result-image" src="" class="hidden w-full h-full object-cover" alt="æ—¥è¨˜é…åœ–">
                            <div id="loading-spinner" class="hidden absolute inset-0 bg-white/80 flex flex-col items-center justify-center">
                                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-orange-500 mb-2"></div><span class="text-orange-600 text-sm font-bold">AI æ­£åœ¨ç¹ªè£½ä¸­...</span>
                            </div>
                        </div>
                        <div id="control-upload" class="mt-auto">
                            <label class="block w-full cursor-pointer bg-white border border-gray-300 hover:border-orange-400 text-gray-700 hover:text-orange-600 py-3 rounded-xl text-center transition-all border-dashed border-2">
                                <input type="file" class="hidden" accept="image/*" onchange="handleFileUpload(this)">
                                <span>ğŸ“· é¸æ“‡ç›¸ç‰‡</span>
                            </label>
                        </div>
                        <div id="control-ai" class="mt-auto hidden">
                            <button onclick="generateAIImage()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white py-3 rounded-xl font-bold shadow-md transition-all flex items-center justify-center gap-2">
                                âœ¨ é–‹å§‹ç”Ÿæˆåœ–åƒ
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t border-gray-100">
                    <div id="btn-group-create" class="flex justify-between">
                        <button onclick="navigate('step-4')" class="px-6 py-2 text-gray-500 hover:text-gray-800 flex items-center">è¿”å›ä¿®æ”¹</button>
                        <button onclick="initiateSaveSequence()" class="px-10 py-3 bg-green-500 hover:bg-green-600 text-white rounded-full font-bold shadow-lg transition-all transform hover:scale-105">å®Œæˆä¸¦å„²å­˜æ—¥è¨˜</button>
                    </div>
                    <div id="btn-group-view" class="hidden flex justify-center">
                        <button onclick="navigate('day-list')" class="px-8 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-full font-bold shadow-md transition-all">è¿”å›æ—¥è¨˜åˆ—è¡¨</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- 9. å…±æ„Ÿç•«å¸ƒ View -->
        <main id="view-canvas" class="hidden-view flex-grow flex flex-col items-center px-4 py-6 md:py-8 fade-in">
            <div class="max-w-7xl w-full flex flex-col h-full">
                <!-- Header -->
                <div class="flex items-center justify-between mb-2">
                    <button onclick="navigate('home')" class="flex items-center text-gray-500 hover:text-orange-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        è¿”å›é¦–é 
                    </button>
                    <h2 class="text-2xl font-bold" style="color: #f79646;">å…±æ„Ÿç•«å¸ƒ</h2>
                    <div class="w-20"></div> 
                </div>
                <!-- è­¦èª -->
                <div class="text-center mb-6">
                    <p class="text-gray-500 text-sm bg-orange-50 inline-block px-4 py-2 rounded-full border border-orange-100">
                        âš ï¸ è«‹ç™¼è¨€æ™‚è«‹å°Šé‡ä»–äººç‚ºåŸå‰‡ï¼Œä¸æ¶‰åŠäººèº«æ”»æ“Šã€æ­§è¦–ã€è¬¾ç½µæˆ–ä¸ç•¶è¨€è«–ã€‚
                    </p>
                </div>
                <!-- ç€‘å¸ƒæµ -->
                <div id="canvas-posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-6"></div>
            </div>
        </main>

        <!-- 10. å€‹äººæª”æ¡ˆèˆ‡æˆå°± View -->
        <main id="view-profile" class="hidden-view flex-grow flex flex-col items-center px-2 py-4 md:px-4 md:py-8 fade-in">
            <div class="max-w-5xl w-full bg-white rounded-3xl shadow-sm p-4 md:p-8">
                <!-- Header -->
                <div class="flex items-center justify-between mb-8">
                    <button onclick="navigate('home')" class="flex items-center text-gray-500 hover:text-orange-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        è¿”å›é¦–é 
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800">å€‹äººæª”æ¡ˆèˆ‡æˆå°±</h2>
                    <div class="w-20"></div> 
                </div>

                <!-- å€‹äººè³‡è¨Š (ç°¡åŒ–ç‰ˆ) -->
                <div class="bg-white border border-gray-200 rounded-2xl p-6 mb-8 shadow-sm flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex items-center gap-4">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800">å°æ˜</h3>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="bg-gray-50 px-4 py-2 rounded-xl border border-gray-100"><span class="block text-xs text-gray-400">æ—¥è¨˜</span><span class="font-bold text-gray-800 text-lg">12</span></div>
                        <div class="bg-gray-50 px-4 py-2 rounded-xl border border-gray-100"><span class="block text-xs text-gray-400">èƒ½é‡é»</span><span class="font-bold text-orange-500 text-lg" id="profile-points-display">58</span></div>
                        <div class="bg-gray-50 px-4 py-2 rounded-xl border border-gray-100"><span class="block text-xs text-gray-400">é“å…·</span><span class="font-bold text-purple-600 text-lg" id="profile-items-display">4</span></div>
                    </div>
                </div>

                <!-- 14å¤©æŒ‘æˆ° (é€²åº¦æ¢æ¨£å¼) -->
                <div class="mb-10">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center"><span class="text-2xl mr-2">ğŸ”¥</span>14å¤©æ—¥è¨˜æŒ‘æˆ°</h3>
                        <span class="text-orange-600 font-bold bg-orange-100 px-3 py-1 rounded-full text-sm" id="challenge-status-text">æŒ‘æˆ°é€²è¡Œä¸­ï¼šç¬¬ 5 å¤©</span>
                    </div>
                    <div class="bg-gray-50 rounded-2xl p-6">
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-bold text-gray-500">æŒ‘æˆ°é€²åº¦</span>
                            <span class="text-sm font-bold text-orange-600" id="challenge-text">5 / 14 å¤©</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6 dark:bg-gray-200 overflow-hidden relative shadow-inner">
                            <!-- Progress Bar -->
                            <div class="bg-gradient-to-r from-orange-400 to-orange-600 h-6 rounded-full progress-bar-fill flex items-center justify-end pr-2" style="width: 0%" id="challenge-bar">
                                <span class="text-white text-xs font-bold shadow-sm" id="challenge-percent">0%</span>
                            </div>
                        </div>
                        <!-- Milestones indicators below -->
                        <div class="flex justify-between text-xs text-gray-400 mt-2 font-bold px-1 relative">
                            <!-- Simple markers positioning -->
                            <span style="left: 0%" class="absolute">Start</span>
                            <span style="left: 21%" class="absolute text-center transform -translate-x-1/2">Day 3<br>ğŸ¥‰</span>
                            <span style="left: 50%" class="absolute text-center transform -translate-x-1/2">Day 7<br>ğŸ¥ˆ</span>
                            <span style="right: 0%" class="absolute text-right">Day 14<br>ğŸ¥‡</span>
                        </div>
                        <!-- Spacer for absolute text below -->
                        <div class="h-8"></div>
                        <p class="text-center text-gray-500 text-sm mt-2">æ¯å¤©ç´€éŒ„ä¸€ç¯‡æ—¥è¨˜ï¼Œé€£çºŒ 14 å¤©å³å¯å®ŒæˆæŒ‘æˆ°ä¸¦ç²å¾—ã€Œæƒ…ç·’ç®¡ç†é”äººã€å‹³ç« ï¼</p>
                    </div>
                </div>

                <!-- è§’è‰²èˆ‡é“å…·å•†åº— (æ•´åˆå€å¡Š) -->
                <div class="mb-10">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="text-2xl mr-2">ğŸ›ï¸</span>è§’è‰²èˆ‡é“å…·å•†åº—</h3>
                    <p class="text-gray-500 text-sm mb-6 bg-yellow-50 inline-block px-3 py-1 rounded-lg border border-yellow-100">ä½¿ç”¨èƒ½é‡é»è§£é–é…·ç‚«é“å…·ï¼Œè§’è‰²æœƒé¦¬ä¸Šç©¿ä¸Šå–”ï¼</p>
                    
                    <!-- Modified Container for Mobile Side-by-Side -->
                    <div class="flex flex-row gap-4 items-start relative">
                        
                        <!-- å·¦å´: è§’è‰²é è¦½ (Sticky on both mobile and desktop) -->
                        <div class="w-full md:w-1/3 flex flex-col items-center bg-orange-50 rounded-2xl p-6 border border-orange-100 sticky top-24 z-10">
                            <h4 class="text-lg font-bold text-gray-700 mb-4">ä½ çš„è§’è‰²</h4>
                            <!-- å‹•æ…‹è§’è‰² Avatar -->
                            <div class="relative w-full aspect-square max-w-[240px]"> <!-- Responsive width -->
                                <!-- Avatar Container: æ”¹ç‚ºç›¸å°å®šä½çš„ Divï¼Œç”¨ä¾†æ”¾åœ–ç‰‡å±¤ -->
                                    <div class="w-full h-full bg-white rounded-full border-4 border-orange-200 shadow-lg relative overflow-hidden" id="avatar-container">
                                        <!-- é€™è£¡çš„å…§å®¹æœƒç”± JS å‹•æ…‹ç”Ÿæˆ -->
                                    </div>
                            </div>
                        </div>

                        <!-- å³å´: å•†åº— UI -->
                        <div class="w-7/12 md:w-2/3">
                            <!-- å•†åº—åˆ†é¡ Tabs (Mobile: Scrollable) -->
                            <div class="flex flex-wrap gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar" id="shop-tabs">
                                <button onclick="filterShop('body')" class="shop-tab inactive whitespace-nowrap" id="tab-body">é¡è‰²</button>
                                <button onclick="filterShop('face')" class="shop-tab inactive whitespace-nowrap" id="tab-face">è¡¨æƒ…</button>
                                <button onclick="filterShop('glasses')" class="shop-tab inactive whitespace-nowrap" id="tab-glasses">çœ¼é¡</button>
                                <button onclick="filterShop('hair')" class="shop-tab inactive whitespace-nowrap" id="tab-hair">é ­é«®</button>
                                <button onclick="filterShop('hat')" class="shop-tab inactive whitespace-nowrap" id="tab-hat">å¸½å­</button>
                                <button onclick="filterShop('accessories')" class="shop-tab inactive whitespace-nowrap" id="tab-accessories">é…ä»¶</button>
                                <button onclick="filterShop('hand')" class="shop-tab inactive whitespace-nowrap" id="tab-hand">æ‰‹æŒå°ç‰©</button>

                                
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3" id="shop-container">
                                <!-- JS å°‡æœƒå¡«å……é€™è£¡ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¦®è­½å‹³ç« ç‰† -->
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><span class="text-2xl mr-2">ğŸ…</span>æ¦®è­½å‹³ç« ç‰†</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4" id="badges-container">
                        <!-- å‹³ç« æœƒç”± JS ç”¢ç”Ÿ -->
                    </div>
                </div>
            </div>
        </main>

        <!-- 11. æ’è¡Œæ¦œ View (New) -->
        <main id="view-leaderboard" class="hidden-view flex-grow flex flex-col items-center px-4 py-6 md:py-8 fade-in">
            <div class="max-w-4xl w-full bg-white rounded-3xl shadow-sm p-6 md:p-8">
                <!-- Header -->
                <div class="flex items-center justify-between mb-8">
                    <button onclick="navigate('home')" class="flex items-center text-gray-500 hover:text-orange-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        è¿”å›é¦–é 
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-yellow-500">ğŸ†</span> æ¦®è­½æ’è¡Œæ¦œ</h2>
                    <div class="w-20"></div> 
                </div>

                <div class="bg-orange-50 rounded-2xl p-4 mb-6 text-center text-sm text-gray-600 border border-orange-100">
                    æ’è¡Œæ¦œä¾æ“šæ¯ä½åŒå­¸ç²å¾—çš„<span class="font-bold text-orange-600">å‹³ç« æ•¸é‡</span>é€²è¡Œæ’åºã€‚
                </div>

                <!-- æ’è¡Œæ¦œåˆ—è¡¨ -->
                <div class="space-y-4" id="leaderboard-list">
                    <!-- JS æœƒå¡«å……é€™è£¡ -->
                </div>
            </div>
        </main>

    </div>

    <!-- Modals -->
    <!-- ç²¾éˆä¿¡ä»¶ Modal -->
    <div id="modal-spirit-letter" class="fixed inset-0 z-[70] hidden modal-overlay flex items-center justify-center px-4 fade-in">
        <div class="bg-white rounded-3xl max-w-lg w-full p-6 md:p-8 relative shadow-2xl border-4 border-orange-100 overflow-hidden max-h-[90vh] flex flex-col">
            <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-orange-50 to-transparent pointer-events-none"></div>
            <div class="text-center relative z-10 flex flex-col h-full overflow-hidden">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex-shrink-0 flex items-center justify-center mx-auto mb-4 border-4 border-white shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                </div>
                <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-2 flex-shrink-0">ä¾†è‡ªç²¾éˆçš„ä¿¡</h3>
                <p class="text-sm text-gray-500 mb-4 flex-shrink-0">æ£®æ—è£¡çš„ç²¾éˆè®€äº†ä½ çš„å¿ƒè²ï¼Œæä¾†äº†ä¸€å°ä¿¡...</p>
                <div class="bg-orange-50 p-6 rounded-2xl text-left mb-6 overflow-y-auto flex-grow min-h-[100px]">
                    <p id="spirit-message-content" class="text-gray-700 leading-relaxed whitespace-pre-wrap">æ­£åœ¨æ¥æ”¶ç²¾éˆçš„è¨Šæ¯...</p>
                </div>
                <button onclick="closeSpiritModal()" class="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold shadow-md transition-all flex-shrink-0">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <!-- è³¼è²·ç¢ºèª Modal -->
    <div id="modal-buy-confirm" class="fixed inset-0 z-[80] hidden modal-overlay flex items-center justify-center px-4 fade-in">
        <div class="bg-white rounded-3xl max-w-sm w-full p-6 relative shadow-2xl flex flex-col items-center text-center">
            <div id="buy-modal-icon"></div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">ç¢ºèªè³¼è²·ï¼Ÿ</h3>
            <p class="text-gray-600 mb-6 text-sm">
                ç¢ºå®šè¦èŠ±è²» <span class="font-bold text-orange-500 text-lg" id="buy-modal-price">0</span>èƒ½é‡é»<br>
                è§£é–ã€Œ<span class="font-bold text-gray-800" id="buy-modal-name">é“å…·åç¨±</span>ã€å—ï¼Ÿ
            </p>
            <div class="flex gap-3 w-full">
                <button onclick="closeBuyModal()" class="flex-1 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold transition-all">å†æƒ³æƒ³</button>
                <button onclick="confirmPurchase()" class="flex-1 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold shadow-md transition-all">ç¢ºèªè³¼è²·</button>
            </div>
        </div>
    </div>

    <!-- å‹³ç« è§£é– Modal -->
    <div id="modal-badge-unlocked" class="fixed inset-0 z-[90] hidden modal-overlay flex items-center justify-center px-4 fade-in">
        <div class="bg-white rounded-3xl max-w-sm w-full p-8 relative shadow-2xl flex flex-col items-center text-center overflow-hidden badge-pop-enter">
            <!-- å…‰èŠ’ç‰¹æ•ˆ -->
            <div class="shine-effect"></div>
            
            <div class="relative z-10 w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center text-5xl mb-6 shadow-md border-4 border-white">
                <span id="badge-modal-icon">ğŸ…</span>
            </div>
            <h3 class="relative z-10 text-2xl font-bold text-gray-800 mb-1">æ­å–œè§£é–å‹³ç« ï¼</h3>
            <h4 class="relative z-10 text-xl font-bold text-orange-500 mb-4" id="badge-modal-name">å‹³ç« åç¨±</h4>
            <p class="relative z-10 text-gray-500 mb-8 text-sm">
                ä½ é”æˆäº†ä¸€å€‹æ–°çš„é‡Œç¨‹ç¢‘ï¼<br>ç¹¼çºŒä¿æŒï¼Œæ”¶é›†æ›´å¤šæ¦®è­½å§ï¼
            </p>
            <button onclick="closeBadgeModal()" class="relative z-10 w-full py-3 bg-gradient-to-r from-orange-400 to-orange-600 hover:from-orange-500 hover:to-orange-700 text-white rounded-xl font-bold shadow-md transition-all transform hover:scale-105">å¤ªæ£’äº†ï¼</button>
        </div>
    </div>

    <!-- åˆ†äº« Modal -->
    <div id="modal-share-canvas" class="fixed inset-0 z-[70] hidden modal-overlay flex items-center justify-center px-4 fade-in">
        <div class="bg-white rounded-3xl max-w-md w-full p-8 relative shadow-2xl">
            <div class="text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">æ˜¯å¦åˆ†äº«è‡³å…±æ„Ÿç•«å¸ƒï¼Ÿ</h3>
                <p class="text-gray-600 mb-6 px-2">åˆ†äº«å¾Œå°‡éš±è—éƒ¨åˆ†è³‡è¨Šï¼ŒåŒ¿åç™¼ä½ˆã€‚<br><span class="text-orange-600 font-bold mt-2 block">å¯ç²å¾— 10 èƒ½é‡é»ï¼</span></p>
                <div class="flex gap-4">
                    <button onclick="handleShare(false)" class="flex-1 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold transition-all">ä¸ç”¨äº†</button>
                    <button onclick="handleShare(true)" class="flex-1 py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold shadow-md transition-all flex items-center justify-center gap-1">åˆ†äº« <span class="text-xs bg-white/20 px-1.5 py-0.5 rounded-full ml-1">+5</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-xl opacity-0 transition-opacity duration-300 pointer-events-none z-[80] text-sm md:text-base shadow-lg"></div>

    <script>
        // --- ç‹€æ…‹è®Šæ•¸ ---
        let currentDay = 1;
        let currentYear = 2026;
        let currentMonth = 4;
        let userPoints = 200; // åˆå§‹åˆ†æ•¸æ¨¡æ“¬ (æé«˜æ–¹ä¾¿æ¸¬è©¦)
        let tempDiaryEntry = null;
        let currentImage = null;
        let currentShopCategory = 'body'; // é è¨­å•†åº—åˆ†é¡
        let pendingItem = null; // å¾…è³¼è²·é“å…·
        const views = ['home', 'calendar', 'day-list', 'step-1', 'step-2', 'step-3', 'step-4', 'preview', 'canvas', 'profile', 'leaderboard'];
        const diaryData = {};

        // æ¨¡æ“¬ä½¿ç”¨è€…æˆå°±ç‹€æ…‹ (å°æ˜)
        const userStats = {
            consecutiveDays: 5,     // é€£çºŒå¤©æ•¸
            replyCount: 8,          // å›è¦†åŒå­¸æ¬¡æ•¸
            classAnswers: 6,        // èª²å ‚å›ç­”æ¬¡æ•¸
            itemsUnlocked: 0,       // è§£é–é“å…·æ•¸ (æœƒåœ¨ onload æ ¡æ­£)
            goodAssignment: true,   // ä½œæ¥­è¡¨ç¾è‰¯å¥½
            diaryComplete: true     // æ—¥è¨˜è¡¨é”å®Œæ•´
        };

        // æ¨¡æ“¬å…¶ä»–å­¸ç”Ÿçš„æ•¸æ“š (æ’è¡Œæ¦œç”¨)
        const mockStudents = [
            {
                name: "å°è¯",
                badgeCount: 8,
                badges: ["æƒ…ç·’ç´€éŒ„è€…", "æƒ…ç·’è§€å¯Ÿå“¡", "æº«æš–å›æ‡‰è€…", "æ”¶é›†è€…"],
                avatarConfig: { bodyColor: '#f87171', faceColor: '#fee2e2', hair: 'item9', glasses: 'item2', face: null, action: 'item3' }
            },
            {
                name: "å°ç¾",
                badgeCount: 6,
                badges: ["æƒ…ç·’ç´€éŒ„è€…", "èª²å ‚ç©æ¥µåƒèˆ‡è€…", "ç†è§£ä»–äººè€…"],
                avatarConfig: { bodyColor: '#60a5fa', faceColor: '#fecaca', hair: 'item10', glasses: null, face: 'item1', action: null }
            },
            {
                name: "é˜¿å¼·",
                badgeCount: 4,
                badges: ["æƒ…ç·’ç´€éŒ„è€…", "æ”¶é›†è€…"],
                avatarConfig: { bodyColor: '#facc15', faceColor: '#fef08a', hair: null, glasses: 'item2', face: null, action: 'item5' }
            },
            {
                name: "å°è‰",
                badgeCount: 9,
                badges: ["æƒ…ç·’ç®¡ç†é”äºº", "æƒ…ç·’è§€å¯Ÿå“¡", "æº«æš–å›æ‡‰è€…", "æ”¶é›†å°ˆå®¶", "ä½œæ¥­è¡¨ç¾è‰¯å¥½"],
                avatarConfig: { bodyColor: '#a78bfa', faceColor: '#ede9fe', hair: 'item10', glasses: null, face: 'item1', action: 'item8' }
            }
        ];

        // å•†åº—é“å…·è³‡æ–™ (åŒ…å«åˆ†é¡ã€åƒ¹éŒ¢ã€é–å®šç‹€æ…‹ã€è£å‚™ç‹€æ…‹)
        const shopItems = [
            // èº«é«” (Body) - å¿…é ˆé¸ä¸€å€‹ï¼Œå–ä»£åŸæœ¬çš„é¡è‰²äº’æ–¥
            // è«‹æ›¿æ›é€™è£¡çš„ URL ç‚ºæ‚¨çš„èº«é«”åœ–ç‰‡
            { id: 'body1', category: 'body', name: 'æ©™è‰²', price: 0, unlocked: true, equipped: true, zIndex: 10, imgSrc: 'https://i.ibb.co/nN3Ry5Qh/9.png' }, 
            { id: 'body2', category: 'body', name: 'ç²‰è‰²', price: 20, unlocked: false, equipped: false, zIndex: 10, imgSrc: 'https://i.ibb.co/HDLFFZ8Q/6.png' }, // ç¤ºæ„ï¼šå¯¦éš›è«‹æ›æˆç´…è‰²çš„åœ–
            { id: 'body3', category: 'body', name: 'ç°è‰²', price: 20, unlocked: false, equipped: false, zIndex: 10, imgSrc: 'https://i.ibb.co/SDjhnH1z/7.png' },
            { id: 'body4', category: 'body', name: 'éµé»ƒè‰²', price: 25, unlocked: false, equipped: false, zIndex: 10, imgSrc: 'https://i.ibb.co/Lh85WH5Y/11.png' },
            { id: 'body5', category: 'body', name: 'è—è‰²', price: 25, unlocked: false, equipped: false, zIndex: 10, imgSrc: 'https://i.ibb.co/8nqqqgDp/14.png' },
            { id: 'body6', category: 'body', name: 'ç´«è‰²', price: 25, unlocked: false, equipped: false, zIndex: 10, imgSrc: 'https://i.ibb.co/G3R5wk20/16.png' },
            { id: 'body7', category: 'body', name: 'ç¶ è‰²', price: 25, unlocked: false, equipped: false, zIndex: 10, imgSrc: 'https://i.ibb.co/hRRbThmv/20.png' },
            
            // é ­é«® (Hair) - zIndex: 30
            { id: 'hair1', category: 'hair', name: 'çŸ­é«®_æ²¹é ­', price: 40, unlocked: false, equipped: false, zIndex: 30, imgSrc: 'https://i.ibb.co/QFNz8ZBr/24.png' },
            { id: 'hair2', category: 'hair', name: 'çŸ­æ²é«®_ç¾Šæ¯›æ²', price: 45, unlocked: false, equipped: false, zIndex: 30, imgSrc: 'https://i.ibb.co/4L6SYDJ/26.png' },
            { id: 'hair3', category: 'hair', name: 'ä¸­æ²é«®_å¾©å¤æ²', price: 40, unlocked: false, equipped: false, zIndex:30, imgSrc: 'https://i.ibb.co/7LxMtqd/23.png' },
            { id: 'hair4', category: 'hair', name: 'çŸ­æ²é«®_ç€æµ·', price: 40, unlocked: false, equipped: false, zIndex: 30, imgSrc: 'https://i.ibb.co/gLKhGYky/29.png' },
            { id: 'hair5', category: 'hair', name: 'çŸ­æ²é«®_ç„¡ç€æµ·', price: 40, unlocked: false, equipped: false, zIndex: 30, imgSrc: 'https://i.ibb.co/tpSCv6gZ/25.png' },
            { id: 'hair6', category: 'hair', name: 'é•·é«®_ç€æµ·', price: 40, unlocked: false, equipped: false, zIndex: 30, imgSrc: 'https://i.ibb.co/Q3mVjxBB/28.png' },
            { id: 'hair7', category: 'hair', name: 'çŸ­é«®_ç„¡ç€æµ·', price: 40, unlocked: false, equipped: false, zIndex: 30, imgSrc: 'https://i.ibb.co/tpSCv6gZ/25.png' },

            // çœ¼é¡ (Glasses) - zIndex: 40
            { id: 'glasses1', category: 'glasses', name: 'åœ“æ¡†çœ¼é¡', price: 30, unlocked: false, equipped: false, zIndex: 40, imgSrc: 'https://i.ibb.co/WNFThVFp/22.png' },
            { id: 'glasses3', category: 'glasses', name: 'é»‘è‰²å¢¨é¡', price: 30, unlocked: false, equipped: false, zIndex: 40, imgSrc: 'https://i.ibb.co/rJpLyhR/24.png' },
            { id: 'glasses4', category: 'glasses', name: 'è—è‰²å¢¨é¡', price: 30, unlocked: false, equipped: false, zIndex: 40, imgSrc: 'https://i.ibb.co/TxTvdGhh/25.png' },
            { id: 'glasses5', category: 'glasses', name: 'é³³æ¢¨å¢¨é¡', price: 30, unlocked: false, equipped: false, zIndex: 40, imgSrc: 'https://i.ibb.co/Mk9pCnVQ/26.png' },
            { id: 'glasses6', category: 'glasses', name: 'èŠ±èŠ±å¢¨é¡', price: 30, unlocked: false, equipped: false, zIndex: 40, imgSrc: 'https://i.ibb.co/V0WP15HK/27.png' },
            { id: 'glasses7', category: 'glasses', name: 'è±¹ç´‹å¢¨é¡', price: 30, unlocked: false, equipped: false, zIndex: 40, imgSrc: 'https://i.ibb.co/HTBSVvSG/28.png' },
            { id: 'glasses8', category: 'glasses', name: 'ç”Ÿæ—¥å¿«æ¨‚å¢¨é¡', price: 30, unlocked: false, equipped: false, zIndex: 40, imgSrc: 'https://i.ibb.co/N6y0SJRL/29.png' },

            // è¡¨æƒ… (Face) - zIndex: 20
            { id: 'face1', category: 'face', name: 'å–œ', price: 30, unlocked: true, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/7tbM6Nxy/30.png' },
            { id: 'face2', category: 'face', name: 'æ¨‚', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/5gby29g3/31.png' },
            { id: 'face3', category: 'face', name: 'æ€•', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/W4fWd4s9/32.png' },
            { id: 'face4', category: 'face', name: 'æ€’', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/rKNDyJZz/33.png' },
            { id: 'face5', category: 'face', name: 'æ³£', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/HTZYjLZ0/34.png' },
            { id: 'face6', category: 'face', name: 'æ„£', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/gZhwspzy/35.png' },
            { id: 'face7', category: 'face', name: 'å‘†', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/S4Bmx8j6/36.png' },

            // å¸½å­ (Hat) - zIndex: 50
            { id: 'hat1', category: 'hat', name: 'è‰å¸½', price: 30, unlocked: false, equipped: false, zIndex: 50, imgSrc: 'https://i.ibb.co/tM56J1T4/3.png' },
            { id: 'hat2', category: 'hat', name: 'è–èª•å¸½', price: 30, unlocked: false, equipped: false, zIndex: 50, imgSrc: 'https://i.ibb.co/h1WG0Wz2/4.png' },
            { id: 'hat3', category: 'hat', name: 'å—ç“œå¸½', price: 30, unlocked: false, equipped: false, zIndex: 50, imgSrc: 'https://i.ibb.co/9mgtGjN7/5.png' },
            { id: 'hat4', category: 'hat', name: 'é­”æ³•å¸½', price: 30, unlocked: false, equipped: false, zIndex: 50, imgSrc: 'https://i.ibb.co/8gFbSPsd/6.png' },
            { id: 'hat5', category: 'hat', name: 'è–èª•å¸½', price: 30, unlocked: false, equipped: false, zIndex: 50, imgSrc: 'https://i.ibb.co/hJGPS3sP/7.png' },

            // é…ä»¶ (Accessories) - zIndex: 50
            { id: 'accessories1', category: 'accessories', name: 'è—è´è¶çµ', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/xqP08qgS/8.png' },
            { id: 'accessories2', category: 'accessories', name: 'ç´…è´è¶çµ', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/0VfqD0VD/9.png' },
            { id: 'accessories3', category: 'accessories', name: 'é»é»é ˜å¸¶', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/gLgDdd69/10.png' },
            { id: 'accessories4', category: 'accessories', name: 'æ¢ç´‹é ˜å¸¶', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/GfFr8CkR/11.png' },
            { id: 'accessories5', category: 'accessories', name: 'é¬å­', price: 30, unlocked: false, equipped: false, zIndex: 20, imgSrc: 'https://i.ibb.co/LDy2P4K5/12.png' },

            // æ‰‹æŒå°ç‰© (Hand) - zIndex: 60
            { id: 'hand1', category: 'hand', name: 'ç•«ç›¤', price: 30, unlocked: false, equipped: false, zIndex: 60, imgSrc: 'https://i.ibb.co/Lz02vR1k/14.png' },
            { id: 'hand2', category: 'hand', name: 'ç•«ç­†', price: 30, unlocked: false, equipped: false, zIndex: 60, imgSrc: 'https://i.ibb.co/mCyhs5QB/15.png' },
            { id: 'hand3', category: 'hand', name: 'æ³°è¿ªç†Š', price: 30, unlocked: false, equipped: false, zIndex: 60, imgSrc: 'https://i.ibb.co/JWtckqTS/16.png' },
            { id: 'hand4', category: 'hand', name: 'çå¥¶', price: 30, unlocked: false, equipped: false, zIndex: 60, imgSrc: 'https://i.ibb.co/Vcmj0JHc/17.png' },
            { id: 'hand5', category: 'hand', name: 'æ¼¢å ¡', price: 30, unlocked: false, equipped: false, zIndex: 60, imgSrc: 'https://i.ibb.co/8gNcSD2Y/18.png' },
            { id: 'hand6', category: 'hand', name: 'è–¯æ¢', price: 30, unlocked: false, equipped: false, zIndex: 60, imgSrc: 'https://i.ibb.co/Wpz5vWGT/19.png' },
            { id: 'hand7', category: 'hand', name: 'å†°æ·‡æ·‹', price: 30, unlocked: false, equipped: false, zIndex: 60, imgSrc: 'https://i.ibb.co/wZkKjm16/20.png' },
            { id: 'hand8', category: 'hand', name: 'ç›¸æ©Ÿ', price: 30, unlocked: false, equipped: false, zIndex: 60, imgSrc: 'https://i.ibb.co/35PKdjft/21.png' },
            { id: 'hand9', category: 'hand', name: 'æ‰‹æ©Ÿ', price: 30, unlocked: false, equipped: false, zIndex: 60, imgSrc: 'https://i.ibb.co/FkZMDCZv/13.png' },
        ];

        // å‹³ç« å®šç¾© (æœƒå‹•æ…‹æª¢æŸ¥ unlocked ç‹€æ…‹)
        // ç‚ºäº†å¯¦ä½œè§£é–é€šçŸ¥ï¼Œæˆ‘å€‘éœ€è¦åœ¨ç‰©ä»¶ä¸­å¢åŠ  unlocked ç‹€æ…‹å±¬æ€§ï¼Œè€Œä¸æ˜¯åªé å‡½æ•¸è¨ˆç®—
        const badgesConfig = [
            { id: 'b1', name: 'æƒ…ç·’ç´€éŒ„è€…', icon: 'ğŸ“', check: () => userStats.consecutiveDays >= 3, unlocked: false },
            { id: 'b2', name: 'æƒ…ç·’è§€å¯Ÿå“¡', icon: 'ğŸ•µï¸', check: () => userStats.consecutiveDays >= 7, unlocked: false },
            { id: 'b3', name: 'æƒ…ç·’ç®¡ç†é”äºº', icon: 'ğŸ§˜', check: () => userStats.consecutiveDays >= 14, unlocked: false },
            { id: 'b4', name: 'ä½œæ¥­è¡¨ç¾è‰¯å¥½', icon: 'ğŸ“š', check: () => userStats.goodAssignment, unlocked: false },
            { id: 'b5', name: 'æƒ…ç·’æ—¥è¨˜è¡¨é”å®Œæ•´', icon: 'ğŸŒŸ', check: () => userStats.diaryComplete, unlocked: false },
            { id: 'b6', name: 'èª²å ‚ç©æ¥µåƒèˆ‡è€…', icon: 'ğŸ™‹', check: () => userStats.classAnswers >= 5, unlocked: false },
            { id: 'b7', name: 'æº«æš–å›æ‡‰è€…', icon: 'â¤ï¸', check: () => userStats.replyCount >= 5, unlocked: false },
            { id: 'b8', name: 'ç†è§£ä»–äººè€…', icon: 'ğŸ¤', check: () => userStats.replyCount >= 10, unlocked: false },
            { id: 'b9', name: 'æ”¶é›†è€…', icon: 'ğŸ’', check: () => userStats.itemsUnlocked >= 4, unlocked: false },
            { id: 'b10', name: 'æ”¶é›†å°ˆå®¶', icon: 'ğŸ†', check: () => userStats.itemsUnlocked >= 8, unlocked: false }
        ];
        
        // æ¨¡æ“¬å…±æ„Ÿç•«å¸ƒè³‡æ–™
        let sharedPosts = [
            {
                id: 1,
                date: "2026/03/28",
                feel: "è¦ºå¾—å¾ˆæŒ«æŠ˜ï¼Œå› ç‚ºåŠªåŠ›äº†å¾ˆä¹…å»æ²’æœ‰é€²æ­¥ï¼Œä½†æˆ‘ç›¸ä¿¡ä¼‘æ¯ä¸€ä¸‹æœƒæ›´å¥½ã€‚",
                image: "https://picsum.photos/seed/10/600/400",
                likes: 12,
                likedByMe: false,
                comments: [{ author: "å°è¯", text: "åŠ æ²¹ï¼æˆ‘ä¹Ÿé‡éé€™æ¨£çš„æƒ…æ³ï¼Œä¼‘æ¯ä¸€ä¸‹å†å‡ºç™¼ï¼" }]
            },
            {
                id: 2,
                date: "2026/03/30",
                feel: "ä»Šå¤©è¶…é–‹å¿ƒçš„ï¼çµ‚æ–¼å®Œæˆäº†å°ˆé¡Œå ±å‘Šï¼Œæ„Ÿè¦ºå¦‚é‡‹é‡è² ã€‚",
                image: "https://picsum.photos/seed/20/600/400",
                likes: 8,
                likedByMe: false,
                comments: []
            }
        ];

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            renderCalendar();
            // åˆå§‹åŒ–ç¯„ä¾‹æŒ‰éˆ•å…§å®¹
            initExamples();
            
            // åˆå§‹åŒ– itemsUnlocked æ•¸é‡
            userStats.itemsUnlocked = shopItems.filter(i => i.unlocked && i.category !== 'body').length; 
            
            // åˆå§‹åŒ–å‹³ç« ç‹€æ…‹ (é¿å…é é¢è¼‰å…¥æ™‚è·³å‡ºé€šçŸ¥)
            badgesConfig.forEach(badge => {
                if (badge.check()) {
                    badge.unlocked = true;
                }
            });
            
            updatePointsUI();
        };

        // --- æª¢æŸ¥ä¸¦è§£é–æ–°å‹³ç«  (æ ¸å¿ƒé‚è¼¯) ---
        function checkBadges() {
            let hasNewUnlock = false;
            
            badgesConfig.forEach(badge => {
                // å¦‚æœæ¢ä»¶æ»¿è¶³ ä¸” å°šæœªè§£é–
                if (badge.check() && !badge.unlocked) {
                    badge.unlocked = true;
                    showBadgeModal(badge);
                    hasNewUnlock = true;
                }
            });

            if (hasNewUnlock && !document.getElementById('view-profile').classList.contains('hidden-view')) {
                renderProfile(); // å¦‚æœæ­£åœ¨å€‹äººé é¢ï¼Œåˆ·æ–°å‹³ç« ç‰†
            }
        }

        // --- å‹³ç«  Modal é‚è¼¯ ---
        function showBadgeModal(badge) {
            document.getElementById('badge-modal-icon').textContent = badge.icon;
            document.getElementById('badge-modal-name').textContent = badge.name;
            document.getElementById('modal-badge-unlocked').classList.remove('hidden');
        }

        function closeBadgeModal() {
            document.getElementById('modal-badge-unlocked').classList.add('hidden');
        }

        // --- ç¯„ä¾‹è³‡æ–™ ---
        function initExamples() {
            const obsContainer = document.getElementById('obs-examples');
            const obsExamples = [
                "ä»Šå¤©åœ¨(ä»€éº¼åœ°æ–¹)æˆ‘(åšä»€éº¼äº‹æƒ…)", "æˆ‘è½åˆ°(ä»€éº¼äº‹æƒ…)", 
                "æˆ‘ä»Šå¤©å’Œ(èª°)åœ¨(å“ªè£¡)(ä»€éº¼äº‹æƒ…)", "ä»Šå¤©(ä»€éº¼æ™‚é–“)ï¼Œ(èª°)å°æˆ‘èªªäº†(ä»€éº¼è©±)", 
                "åœ¨(ä»€éº¼åœ°æ–¹)ï¼Œç™¼ç”Ÿäº†(ä¸€ä»¶ä»€éº¼æ¨£çš„äº‹)", "(ä»€éº¼æ™‚å€™)æˆ‘åœ¨(å“ªè£¡)çœ‹åˆ°(ä»€éº¼äº‹æƒ…)", 
                "ç•¶æˆ‘çœ‹åˆ° / è½åˆ° (ä»€éº¼äº‹æƒ…)"
            ];
            obsContainer.innerHTML = obsExamples.map(text => 
                `<div onclick="addText('input-obs', '${text}')" class="example-chip p-3 rounded-lg text-sm border border-gray-100">${text}</div>`
            ).join('');

            const reqEncourage = document.getElementById('content-encourage');
            const reqCommunicate = document.getElementById('content-communicate');
            const reqCelebrate = document.getElementById('content-celebrate');

            reqEncourage.innerHTML = [
                "å› ç‚ºæˆ‘ç¾åœ¨æ„Ÿåˆ°(æƒ…ç·’)ï¼Œæ‰€ä»¥æˆ‘æ±ºå®šå…ˆ(åšä»€éº¼æ¨£çš„äº‹æƒ…)",
                "ç‚ºäº†ç…§é¡§æˆ‘å°(éœ€æ±‚)çš„é‡è¦–ï¼Œæˆ‘è¦å‘Šè¨´è‡ªå·±ï¼šã€( ä¸€å¥é¼“å‹µè‡ªå·±çš„è©±) ã€",
                "æˆ‘ç¾åœ¨é‚„æ²’æº–å‚™å¥½é¢å°ï¼Œæ‰€ä»¥æˆ‘æ±ºå®šå…ˆ(åšä¸€ä»¶è®“è‡ªå·±å¿«æ¨‚çš„äº‹æƒ…)"
            ].map(t => `<div onclick="addText('input-req', '${t}')" class="example-chip p-3 rounded-lg text-sm border border-gray-100">${t}</div>`).join('');

            reqCommunicate.innerHTML = [
                "ä½ é¡˜ä¸é¡˜æ„(æå‡ºä¸€é …å…·é«”çš„æ–¹æ³•)......", "ä½ å¯ä¸å¯ä»¥(æå‡ºä¸€é …å…·é«”çš„æ–¹æ³•)......"
            ].map(t => `<div onclick="addText('input-req', '${t}')" class="example-chip p-3 rounded-lg text-sm border border-gray-100">${t}</div>`).join('');

            reqCelebrate.innerHTML = [
                "é€™ä»¶äº‹è®“æˆ‘å¤ª(æ„Ÿå—)äº†ï¼æ‰€ä»¥æˆ‘æ±ºå®šå»è·Ÿ(å°è±¡)èªªï¼šã€(æ„Ÿè¬çš„è©±)ã€",
                "ç‚ºäº†è¨˜ä½é€™å€‹ç¾å¥½çš„æ™‚åˆ»ï¼Œæˆ‘æ±ºå®š(åšä¸€å€‹ç´€éŒ„çš„å‹•ä½œ)",
                "æˆ‘è¦(åšä¸€ä»¶é–‹å¿ƒçš„äº‹)ä¾†çå‹µè‡ªå·±ï¼"
            ].map(t => `<div onclick="addText('input-req', '${t}')" class="example-chip p-3 rounded-lg text-sm border border-gray-100">${t}</div>`).join('');
        }

        // --- å°èˆªæ§åˆ¶ ---
        function navigate(viewName) {
            views.forEach(v => document.getElementById(`view-${v}`).classList.add('hidden-view'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden-view');
            
            if (viewName === 'calendar') renderCalendar();
            if (viewName === 'canvas') renderCanvas();
            if (viewName === 'profile') {
                renderProfile();
                filterShop(currentShopCategory); // é è¨­é¡¯ç¤ºé ­é«®
            }
            if (viewName === 'leaderboard') renderLeaderboard(); // æ¸²æŸ“æ’è¡Œæ¦œ
            window.scrollTo(0, 0);
        }

        // --- æ ¸å¿ƒä¿®æ”¹: Avatar HTML ç”¢ç”Ÿå™¨ ---
        function generateAvatarHTML(configMap) {
            // configMap æ˜¯ä¸€å€‹ç‰©ä»¶ï¼Œä¾‹å¦‚ { hair: 'hair1', body: 'body1' ... }
            let layersHtml = '';
            
            // éæ­·æ‰€æœ‰é¡åˆ¥ï¼Œæ‰¾åˆ°å°æ‡‰çš„åœ–ç‰‡ä¸¦æ ¹æ“š zIndex å †ç–Š
            // ç‚ºäº†ç¢ºä¿ zIndex æ­£ç¢ºï¼Œæˆ‘å€‘æ‡‰è©²å» shopItems æ‰¾è³‡æ–™
            const equippedItems = [];
            
            // å°‡ configMap è½‰ç‚º Item ç‰©ä»¶åˆ—è¡¨
            for (const category in configMap) {
                const itemId = configMap[category];
                if (itemId) {
                    const item = shopItems.find(i => i.id === itemId);
                    if (item) equippedItems.push(item);
                }
            }

            // æ ¹æ“š zIndex æ’åº (å°çš„åœ¨å¾Œé¢)
            equippedItems.sort((a, b) => a.zIndex - b.zIndex);

            // ç”¢ç”Ÿ HTML
            equippedItems.forEach(item => {
                // ä½¿ç”¨ object-contain ç¢ºä¿åœ–ç‰‡å®Œæ•´é¡¯ç¤ºï¼Œabsolute inset-0 è®“å®ƒå€‘é‡ç–Š
                // é€™è£¡ä½¿ç”¨äº†å‡åœ–ç‰‡ï¼Œæ‚¨å¯ä»¥å°‡ item.imgSrc æ›æˆçœŸå¯¦è·¯å¾‘
                
                // å¦‚æœæ˜¯èº«é«”é¡è‰²ä¸åŒï¼Œå¯ä»¥åœ¨é€™è£¡åŠ  filterï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ä¸åŒçš„ imgSrc
                let style = `z-index: ${item.zIndex};`;
                layersHtml += `<img src="${item.imgSrc}" class="avatar-layer absolute inset-0 w-full h-full object-contain" style="${style}" alt="${item.name}">`;
            });

            return layersHtml;
        }
        // --- Leaderboard Rendering ---
        function renderLeaderboard() {
            const listContainer = document.getElementById('leaderboard-list');
            listContainer.innerHTML = '';
            const myBadges = badgesConfig.filter(b => b.unlocked);
            
            // å–å¾—æˆ‘ç•¶å‰çš„è£å‚™è¨­å®š
            const myEquippedMap = {};
            shopItems.forEach(item => {
                if(item.equipped) myEquippedMap[item.category] = item.id;
            });

            const me = { name: "å°æ˜ (æˆ‘)", badgeCount: myBadges.length, badges: myBadges.map(b => b.name), avatarConfig: myEquippedMap, isMe: true };
            const allStudents = [me, ...mockStudents];
            allStudents.sort((a, b) => b.badgeCount - a.badgeCount);

            allStudents.forEach((student, index) => {
                const rank = index + 1;
                let rankClass = rank === 1 ? "rank-1" : rank === 2 ? "rank-2" : rank === 3 ? "rank-3" : "rank-other";
                
                // å‘¼å«æ–°çš„ Image Generator
                const avatarHtml = generateAvatarHTML(student.avatarConfig);

                const badgesHtml = student.badges.length > 0 ? student.badges.map(b => `<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-md mr-1 mb-1 inline-block">${b}</span>`).join('') : `<span class="text-xs text-gray-400">å°šæœªç²å¾—å‹³ç« </span>`;

                const row = document.createElement('div');
                row.className = `flex items-center bg-white p-4 rounded-xl border ${student.isMe ? 'border-orange-300 ring-2 ring-orange-100' : 'border-gray-100'} rank-item shadow-sm`;
                row.innerHTML = `
                    <div class="mr-4 flex-shrink-0"><div class="rank-badge ${rankClass}">${rank}</div></div>
                    <div class="w-16 h-16 mr-4 flex-shrink-0 relative">
                        <div class="w-full h-full bg-white rounded-full border-2 border-orange-100 overflow-hidden relative">
                            ${avatarHtml}
                        </div>
                    </div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-gray-800 text-lg">${student.name}</h4>
                            <div class="text-orange-600 font-bold bg-orange-50 px-3 py-1 rounded-full text-sm flex items-center"><span class="mr-1">ğŸ…</span> ${student.badgeCount}</div>
                        </div>
                        <div class="mt-2 flex flex-wrap">${badgesHtml}</div>
                    </div>`;
                listContainer.appendChild(row);
            });
        }


        

        // --- Profile æ¸²æŸ“é‚è¼¯ ---
        function renderProfile() {
            // æ›´æ–° Profile Header æ•¸æ“š
            document.getElementById('profile-points-display').textContent = userPoints;
            document.getElementById('profile-items-display').textContent = userStats.itemsUnlocked;

            // 0. æ¸²æŸ“è§’è‰²å¤–è§€
            updateCharacterAppearance();

            // 1. æ¸²æŸ“æŒ‘æˆ°é€²åº¦æ¢ (Modified for progress bar style)
            const consecutiveDays = userStats.consecutiveDays;
            const totalDays = 14;
            const progressPercent = (consecutiveDays / totalDays) * 100;
            
            // Update text
            document.getElementById('challenge-text').textContent = `${consecutiveDays} / ${totalDays} å¤©`;
            document.getElementById('challenge-status-text').textContent = `æŒ‘æˆ°é€²è¡Œä¸­ï¼šç¬¬ ${consecutiveDays} å¤©`;
            
            // Update bar width and label
            const bar = document.getElementById('challenge-bar');
            bar.style.width = `${progressPercent}%`;
            
            // Ensure percentage text is updated
            const percentText = document.getElementById('challenge-percent');
            percentText.textContent = `${Math.round(progressPercent)}%`;

            // 2. æ¸²æŸ“é“å…·å•†åº— (é€™éƒ¨åˆ†ç¾åœ¨ç”± filterShop è§¸ç™¼)
            // renderShop(); 

            // 3. æ¸²æŸ“å‹³ç« 
            const badgeContainer = document.getElementById('badges-container');
            badgeContainer.innerHTML = '';
            badgesConfig.forEach(badge => {
                const isUnlocked = badge.unlocked; // ä½¿ç”¨ç‹€æ…‹å±¬æ€§è€Œä¸æ˜¯å‡½æ•¸
                const card = document.createElement('div');
                card.className = `badge-card bg-gray-50 rounded-xl p-4 flex flex-col items-center text-center border border-gray-100 ${isUnlocked ? 'bg-white shadow-sm' : 'badge-locked'}`;
                
                const iconBg = isUnlocked ? 'bg-yellow-100' : 'bg-gray-200';
                
                card.innerHTML = `
                    <div class="w-16 h-16 rounded-full ${iconBg} flex items-center justify-center text-3xl mb-3 shadow-inner">
                        ${badge.icon}
                    </div>
                    <h4 class="font-bold text-gray-800 text-sm mb-1">${badge.name}</h4>
                    ${isUnlocked ? '<span class="text-xs text-green-500 font-bold mt-2">âœ¨ å·²è§£é–</span>' : '<span class="text-xs text-gray-400 mt-2">ğŸ”’ æœªè§£é–</span>'}
                `;
                badgeContainer.appendChild(card);
            });
        }

         // --- æ ¸å¿ƒä¿®æ”¹: å€‹äººé é¢è§’è‰²æ›´æ–° ---
        function updateCharacterAppearance() {
            const container = document.getElementById('avatar-container');
            
            // å–å¾—ç›®å‰è£å‚™çš„é …ç›® Map
            const currentEquippedMap = {};
            shopItems.forEach(item => {
                if(item.equipped) currentEquippedMap[item.category] = item.id;
            });

            // æ¸…ç©ºä¸¦é‡æ–°æ’å…¥åœ–ç‰‡
            container.innerHTML = generateAvatarHTML(currentEquippedMap);

            // è¦–è¦ºç‰¹æ•ˆï¼šè§’è‰²å½ˆè·³
            container.classList.remove('avatar-bounce');
            void container.offsetWidth; 
            container.classList.add('avatar-bounce');
        }

        // --- å•†åº—é‚è¼¯ ---
        function filterShop(category) {
            currentShopCategory = category;
            
            // æ›´æ–° Tabs æ¨£å¼
            const tabs = ['hair', 'glasses', 'face', 'body', 'hat', 'accessories', 'hand'];
            tabs.forEach(c => {
                const btn = document.getElementById(`tab-${c}`);
                if (c === category) {
                    btn.classList.add('active');
                    btn.classList.remove('inactive');
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('inactive');
                }
            });

            renderShop(category);
        }

        function renderShop(category) {
            const container = document.getElementById('shop-container');
            container.innerHTML = '';
            const itemsToShow = shopItems.filter(item => item.category === category);
            
            itemsToShow.forEach(item => {
                const card = document.createElement('div');
                card.className = `shop-card bg-white rounded-xl p-4 flex flex-col items-center text-center relative overflow-hidden cursor-pointer ${item.equipped ? 'border-orange-400 bg-orange-50' : (item.unlocked ? 'border-gray-200' : 'border-gray-100')}`;
                card.onclick = () => toggleItem(item.id);

                let statusHtml = '';
                if (item.equipped) statusHtml = `<div class="mt-2 text-xs font-bold text-white bg-orange-500 px-3 py-1 rounded-full">ä½¿ç”¨ä¸­</div>`;
                else if (item.unlocked) statusHtml = `<div class="mt-2 text-xs font-bold text-gray-500 bg-gray-100 px-3 py-1 rounded-full">å·²æ“æœ‰</div>`;
                else statusHtml = `<div class="mt-2 text-xs font-bold text-white bg-green-500 px-3 py-1 rounded-full">$${item.price}</div>`;

                // å•†åº—åœ–æ¨™å¦‚æœæ˜¯åœ–ç‰‡ï¼Œå¯ä»¥é¡¯ç¤ºç¸®ç•¥åœ–
                let iconDisplay = item.imgSrc 
                    ? `<img src="${item.imgSrc}" class="w-8 h-8 object-contain">` 
                    : item.icon;

                card.innerHTML = `<div class="w-12 h-12 rounded-full bg-gray-50 flex items-center justify-center text-2xl mb-2 shadow-inner overflow-hidden">${iconDisplay}</div><h4 class="font-bold text-gray-800 text-sm flex-grow">${item.name}</h4>${statusHtml}`;
                container.appendChild(card);
            });
        }

        function toggleItem(id) {
            const item = shopItems.find(i => i.id === id);
            if (!item) return;

            // æƒ…æ³ 1: å°šæœªè§£é– -> è³¼è²·æµç¨‹ (ä¿®æ”¹ç‚ºå½ˆå‡ºè¦–çª—)
            if (!item.unlocked) {
                if (userPoints >= item.price) {
                    openBuyModal(item);
                } else {
                    showToast("èƒ½é‡é»æ•¸ä¸è¶³ï¼å†å¤šå¯«å¹¾ç¯‡æ—¥è¨˜å§ï¼");
                }
                return;
            }

            // æƒ…æ³ 2: å·²è§£é– -> è£å‚™/å¸ä¸‹æµç¨‹
            if (item.equipped) {
                // å¦‚æœå·²ç¶“è£å‚™ï¼Œå†æ¬¡é»æ“Šæ˜¯å¦å¸ä¸‹ï¼Ÿ
                // å°æ–¼èº«é«”é¡è‰²ï¼Œä¸èƒ½å¸ä¸‹(å¿…é ˆæœ‰ä¸€å€‹)ï¼Œé™¤éåˆ‡æ›ã€‚
                // å°æ–¼é ­é«®/å‹•ä½œï¼Œå¯ä»¥å¸ä¸‹è®Šæˆå…‰é ­/ç©ºæ‰‹ã€‚
                if (item.category === 'body') return; // é¡è‰²ä¸èƒ½å–æ¶ˆï¼Œåªèƒ½æ›åˆ¥çš„
                item.equipped = false;
                showToast(`å¸ä¸‹ ${item.name}`);
            } else {
                equipItem(item);
            }
            
            // æ›´æ–° UI
            updatePointsUI();
            renderProfile(); // æ›´æ–°è§’è‰²èˆ‡æ•¸æ“š
            filterShop(currentShopCategory); // é‡æ–°æ¸²æŸ“å•†åº—ç‹€æ…‹
        }

        function openBuyModal(item) {
            pendingItem = item;
            document.getElementById('buy-modal-name').textContent = item.name;
            document.getElementById('buy-modal-price').textContent = item.price;
            document.getElementById('modal-buy-confirm').classList.remove('hidden');
        }

        function closeBuyModal() {
            document.getElementById('modal-buy-confirm').classList.add('hidden');
            pendingItem = null;
        }

        function confirmPurchase() {
            if (!pendingItem) return;
            
            const item = pendingItem;
            closeBuyModal(); // Close first

            // Execute purchase logic
            userPoints -= item.price;
            item.unlocked = true;
            userStats.itemsUnlocked++; 
            
            showToast(`è³¼è²·æˆåŠŸï¼ç²å¾— ${item.name}`);
            equipItem(item); // Auto equip
            
            updatePointsUI();
            checkBadges(); // è³¼è²·å¾Œæª¢æŸ¥æ˜¯å¦æœ‰æ–°å‹³ç« 
            renderProfile(); 
            filterShop(currentShopCategory);
        }

        function equipItem(targetItem) {
            // æ ¹æ“šé¡åˆ¥è™•ç†äº’æ–¥é‚è¼¯
            if (['hair', 'face', 'glasses', 'body','hat', 'accessories', 'hand'].includes(targetItem.category)) {
                // æ‰¾å‡ºåŒé¡åˆ¥å·²è£å‚™çš„ç‰©å“ï¼Œå°‡å…¶å¸ä¸‹ (body å¿…é¸ä¸€å€‹ï¼Œå…¶ä»–å¯é¸)
                // æ³¨æ„ï¼šå‹•ä½œé¡åˆ¥é€™è£¡è¨­å®šç‚ºäº’æ–¥(ä¸€æ¬¡æ‹¿ä¸€æ¨£)ï¼Œå¦‚æœæƒ³æ··æ­å¯ä¿®æ”¹æ­¤è™•
                shopItems.filter(i => i.category === targetItem.category && i.id !== targetItem.id).forEach(i => i.equipped = false);
            }
            
            targetItem.equipped = true;
            
            // è¦–è¦ºç‰¹æ•ˆï¼šè§’è‰²å½ˆè·³
            const avatar = document.getElementById('avatar-container');
            if(avatar) {
                avatar.classList.remove('avatar-bounce');
                void avatar.offsetWidth; // è§¸ç™¼é‡ç¹ª
                avatar.classList.add('avatar-bounce');
            }
        }

        // --- æ—¥æ›†é‚è¼¯ ---
        function changeMonth(offset) {
            currentMonth += offset;
            if (currentMonth < 1) { currentMonth = 12; currentYear--; } 
            else if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const title = document.getElementById('calendar-title');
            grid.innerHTML = '';
            
            const monthNames = ["", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
            title.textContent = `${currentYear} ${monthNames[currentMonth]}`;

            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            let html = days.map(d => `<div class="font-bold text-gray-400 py-2">${d}</div>`).join('');

            const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
            const totalDays = new Date(currentYear, currentMonth, 0).getDate();

            for(let i=0; i<firstDay; i++) html += `<div class="calendar-day empty"></div>`;
            grid.innerHTML = html;

            for(let i=1; i<=totalDays; i++) {
                const dateStr = `${currentYear}/${String(currentMonth).padStart(2,'0')}/${String(i).padStart(2,'0')}`;
                const entries = diaryData[dateStr];
                
                let style = '', content = `<span class="relative z-10">${i}</span>`, classes = 'text-gray-700';
                if (entries && entries.length > 0) {
                    const imgEntry = [...entries].reverse().find(e => e.image);
                    if (imgEntry) {
                        style = `background-image: url('${imgEntry.image}'); background-size: cover; background-position: center;`;
                        content = `<span class="relative z-10 bg-white/80 px-1.5 py-0.5 rounded-md shadow-sm text-xs md:text-sm font-bold text-orange-800">${i}</span>`;
                        classes = '';
                    } else {
                        content += `<div class="absolute bottom-1 w-1.5 h-1.5 bg-orange-500 rounded-full left-1/2 transform -translate-x-1/2"></div>`;
                    }
                }

                const cell = document.createElement('div');
                cell.className = `calendar-day flex flex-col items-center justify-center text-sm md:text-lg relative overflow-hidden cursor-pointer ${classes}`;
                if (style) cell.style.cssText = style;
                cell.innerHTML = content;
                cell.onclick = () => openDayList(i);
                grid.appendChild(cell);
            }
        }

        // --- æ—¥è¨˜åˆ—è¡¨é‚è¼¯ ---
        function openDayList(day) {
            currentDay = day;
            const dateStr = `${currentYear}/${String(currentMonth).padStart(2,'0')}/${String(day).padStart(2,'0')}`;
            document.getElementById('day-list-title').textContent = dateStr;
            renderEntries(dateStr);
            navigate('day-list');
        }

        function renderEntries(dateStr) {
            const container = document.getElementById('entries-container');
            const entries = diaryData[dateStr] || [];
            container.innerHTML = entries.length === 0 
                ? `<div class="text-center text-gray-400 py-8"><p>ä»Šå¤©é‚„æ²’æœ‰æ—¥è¨˜å–”ï¼</p><p class="text-sm">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ç´€éŒ„</p></div>`
                : '';

            entries.forEach((entry, index) => {
                const imgHtml = entry.image ? `<div class="w-16 h-16 rounded-lg bg-gray-100 overflow-hidden flex-shrink-0 ml-3"><img src="${entry.image}" class="w-full h-full object-cover"></div>` : '';
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-2xl shadow-sm border border-orange-100 flex justify-between items-start cursor-pointer hover:shadow-md transition-shadow";
                card.onclick = () => viewDiaryEntry(dateStr, index);
                card.innerHTML = `
                    <div class="flex-grow overflow-hidden">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold bg-orange-100 text-orange-600 px-2 py-1 rounded-md">ç¬¬ ${index + 1} ç¯‡</span>
                            <span class="text-xs text-gray-400">${entry.time}</span>
                        </div>
                        <h4 class="font-bold text-gray-800 truncate mb-1">${entry.obs ? entry.obs.substring(0, 20) + '...' : 'æœªå‘½åæ—¥è¨˜'}</h4>
                        <p class="text-sm text-gray-500 truncate">${entry.feel ? 'æ„Ÿå—: ' + entry.feel : ''}</p>
                    </div>
                    ${imgHtml}`;
                container.appendChild(card);
            });
        }

        // --- æ—¥è¨˜æª¢è¦–æ¨¡å¼ ---
        function viewDiaryEntry(dateStr, index) {
            const entry = diaryData[dateStr][index];
            document.getElementById('preview-obs').textContent = entry.obs;
            document.getElementById('preview-feel').textContent = entry.feel;
            document.getElementById('preview-need').textContent = entry.need;
            document.getElementById('preview-req').textContent = entry.req;
            document.getElementById('date-display-preview').textContent = entry.date;

            const imgDisplay = document.getElementById('result-image');
            const placeholder = document.getElementById('placeholder-text');
            if (entry.image) {
                imgDisplay.src = entry.image;
                imgDisplay.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                imgDisplay.classList.add('hidden');
                placeholder.classList.remove('hidden');
                placeholder.textContent = "æ­¤ç¯‡æ—¥è¨˜æ²’æœ‰é…åœ–";
            }

            // UI Mode: View
            document.getElementById('image-control-tabs').classList.add('hidden');
            document.getElementById('control-upload').classList.add('hidden');
            document.getElementById('control-ai').classList.add('hidden');
            document.getElementById('btn-group-create').classList.add('hidden');
            document.getElementById('btn-group-view').classList.remove('hidden');
            navigate('preview');
        }

        // --- å¯«ä½œæµç¨‹ ---
        function startWriting() {
            const dateStr = `${currentYear}/${String(currentMonth).padStart(2,'0')}/${String(currentDay).padStart(2,'0')}`;
            document.querySelectorAll('.date-display').forEach(el => el.textContent = dateStr);
            ['input-obs', 'input-feel', 'input-need', 'input-req'].forEach(id => document.getElementById(id).value = '');
            
            currentImage = null;
            document.getElementById('result-image').src = '';
            document.getElementById('result-image').classList.add('hidden');
            document.getElementById('placeholder-text').classList.remove('hidden');
            navigate('step-1');
        }

        function showPreview() {
            const dateStr = `${currentYear}/${String(currentMonth).padStart(2,'0')}/${String(currentDay).padStart(2,'0')}`;
            document.getElementById('date-display-preview').textContent = dateStr;
            document.getElementById('preview-obs').textContent = document.getElementById('input-obs').value || "(æœªå¡«å¯«)";
            document.getElementById('preview-feel').textContent = document.getElementById('input-feel').value || "(æœªå¡«å¯«)";
            document.getElementById('preview-need').textContent = document.getElementById('input-need').value || "(æœªå¡«å¯«)";
            document.getElementById('preview-req').textContent = document.getElementById('input-req').value || "(æœªå¡«å¯«)";

            // UI Mode: Create
            document.getElementById('image-control-tabs').classList.remove('hidden');
            toggleImageMode('upload');
            document.getElementById('btn-group-create').classList.remove('hidden');
            document.getElementById('btn-group-view').classList.add('hidden');
            navigate('preview');
        }

        // --- AI èˆ‡åœ–ç‰‡ ---
        function toggleImageMode(mode) {
            const btnUp = document.getElementById('btn-mode-upload');
            const btnAi = document.getElementById('btn-mode-ai');
            const ctrlUp = document.getElementById('control-upload');
            const ctrlAi = document.getElementById('control-ai');
            
            const activeClass = "px-4 py-2 rounded-md text-sm font-bold bg-orange-100 text-orange-600 transition-all";
            const inactiveClass = "px-4 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-orange-600 transition-all";

            if (mode === 'upload') {
                btnUp.className = activeClass; btnAi.className = inactiveClass;
                ctrlUp.classList.remove('hidden'); ctrlAi.classList.add('hidden');
            } else {
                btnAi.className = activeClass.replace('orange', 'indigo'); btnUp.className = inactiveClass;
                ctrlUp.classList.add('hidden'); ctrlAi.classList.remove('hidden');
            }
        }

        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImage = e.target.result;
                    const img = document.getElementById('result-image');
                    img.src = currentImage; img.classList.remove('hidden');
                    document.getElementById('placeholder-text').classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function generateAIImage() {
            const spinner = document.getElementById('loading-spinner');
            spinner.classList.remove('hidden');
            
            const obs = document.getElementById('input-obs').value;
            const feel = document.getElementById('input-feel').value;
            const need = document.getElementById('input-need').value;
            const prompt = `A soft, artistic illustration for diary. Mood: ${feel}. Need: ${need}. Context: ${obs}. Style: Dreamy watercolor, pastel colors, abstract but comforting.`;

            // æ¨¡æ“¬ AI ç”Ÿæˆ (å¯¦éš›ä¸²æ¥éœ€åœ¨å¾Œç«¯æˆ–å¡«å…¥ Key)
            setTimeout(() => {
                spinner.classList.add('hidden');
                // ä½¿ç”¨ Picsum ä½œç‚ºç¯„ä¾‹
                const randomId = Math.floor(Math.random() * 100);
                currentImage = `https://picsum.photos/seed/${randomId}/600/400`;
                const img = document.getElementById('result-image');
                img.src = currentImage; img.classList.remove('hidden');
                document.getElementById('placeholder-text').classList.add('hidden');
                showToast("AI åœ–åƒç”ŸæˆæˆåŠŸï¼");
            }, 2000);
        }

        // --- å„²å­˜èˆ‡åˆ†äº«æµç¨‹ ---
        async function initiateSaveSequence() {
            const dateStr = `${currentYear}/${String(currentMonth).padStart(2,'0')}/${String(currentDay).padStart(2,'0')}`;
            const now = new Date();
            const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            tempDiaryEntry = {
                date: dateStr, time: timeStr,
                obs: document.getElementById('input-obs').value,
                feel: document.getElementById('input-feel').value,
                need: document.getElementById('input-need').value,
                req: document.getElementById('input-req').value,
                image: currentImage
            };

            document.getElementById('modal-spirit-letter').classList.remove('hidden');
            const msgContent = document.getElementById('spirit-message-content');
            msgContent.innerHTML = `<span class="animate-pulse">âœ¨ ç²¾éˆæ­£åœ¨ç‚ºä½ å¯«ä¿¡ï¼Œè«‹ç¨å€™...</span>`;

            // æ¨¡æ“¬ AI å›ä¿¡
            setTimeout(() => {
                msgContent.textContent = "è¦ªæ„›çš„å­©å­ï¼Œç²¾éˆçœ‹è¦‹äº†ä½ çš„åŠªåŠ›ã€‚æ¯ä¸€å€‹æ„Ÿå—éƒ½æ˜¯éˆé­‚çš„ç¦®ç‰©ï¼Œè«‹æº«æŸ”åœ°æ“æŠ±å®ƒå€‘ã€‚ä½ åšå¾—å¾ˆæ£’ï¼Œä¼‘æ¯ä¸€ä¸‹ï¼Œæ˜å¤©æœƒæ›´å¥½ï¼âœ¨";
            }, 1500);
        }

        function closeSpiritModal() {
            document.getElementById('modal-spirit-letter').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('modal-share-canvas').classList.remove('hidden');
            }, 300);
        }

        function handleShare(shouldShare) {
            document.getElementById('modal-share-canvas').classList.add('hidden');
            
            const dateStr = tempDiaryEntry.date;
            if (!diaryData[dateStr]) diaryData[dateStr] = [];
            diaryData[dateStr].push(tempDiaryEntry);

            if (shouldShare) {
                const newPost = {
                    id: Date.now(),
                    author: "åŒ¿ååŒå­¸",
                    date: tempDiaryEntry.date,
                    feel: tempDiaryEntry.feel,
                    image: tempDiaryEntry.image,
                    likes: 0,
                    likedByMe: false,
                    comments: []
                };
                sharedPosts.unshift(newPost);
                userPoints += 10;
                updatePointsUI();
                showToast("å·²åˆ†äº«ä¸¦ç²å¾— 10 èƒ½é‡é»ï¼");
                checkBadges(); // æª¢æŸ¥åˆ†äº«ç›¸é—œå‹³ç« 
            } else {
                showToast("æ—¥è¨˜å·²å„²å­˜ (ç§äºº)");
            }
            tempDiaryEntry = null;
            navigate('calendar');
        }

        // --- å…±æ„Ÿç•«å¸ƒé‚è¼¯ ---
        function renderCanvas() {
            const container = document.getElementById('canvas-posts-container');
            container.innerHTML = '';

            sharedPosts.forEach(post => {
                const imgHtml = post.image ? 
                    `<div class="w-full aspect-video bg-gray-100 rounded-xl overflow-hidden mb-4 border border-gray-100"><img src="${post.image}" class="w-full h-full object-cover"></div>` : 
                    `<div class="w-full h-24 bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl mb-4 flex items-center justify-center text-orange-300 italic text-sm">æ­¤è²¼æ–‡ç„¡é…åœ–</div>`;

                const commentsHtml = post.comments.map(c => 
                    `<div class="text-sm bg-gray-50 p-2 rounded-lg mb-1"><span class="font-bold text-gray-700">${c.author}:</span> <span class="text-gray-600">${c.text}</span></div>`
                ).join('');

                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col h-full";
                card.innerHTML = `
                    <div class="mb-4"><div class="text-sm text-gray-400 font-medium">${post.date}</div></div>
                    ${imgHtml}
                    <div class="bg-orange-50 p-4 rounded-xl mb-4 border-l-4 border-orange-300">
                        <span class="text-xs font-bold text-orange-500 block mb-1">æˆ‘çš„æ„Ÿå—</span>
                        <p class="text-gray-700">${post.feel}</p>
                    </div>
                    <div class="flex items-center justify-between pt-4 border-t border-gray-100 mt-auto">
                        <button onclick="toggleLike(${post.id})" class="flex items-center space-x-2 text-gray-500 hover:text-red-500 transition-colors ${post.likedByMe ? 'like-active text-red-500' : ''}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="${post.likedByMe ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                            <span>${post.likes}</span>
                        </button>
                        <div class="flex items-center text-gray-400 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                            ${post.comments.length} ç•™è¨€
                        </div>
                    </div>
                    <div class="mt-4 space-y-2 max-h-32 overflow-y-auto">${commentsHtml}</div>
                    <div class="mt-4 flex gap-2">
                        <input type="text" id="comment-input-${post.id}" placeholder="å¯«ä¸‹ä½ çš„é¼“å‹µ..." class="flex-grow bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        <button onclick="addComment(${post.id})" class="bg-orange-500 hover:bg-orange-600 text-white text-sm px-4 py-2 rounded-lg font-bold transition-all whitespace-nowrap">ç™¼é€</button>
                    </div>`;
                container.appendChild(card);
            });
        }

        function toggleLike(postId) {
            const post = sharedPosts.find(p => p.id === postId);
            if (post) {
                if (post.likedByMe) {
                    post.likes--; post.likedByMe = false;
                    userPoints = Math.max(0, userPoints - 2);
                    showToast("å–æ¶ˆæ„›å¿ƒ");
                } else {
                    post.likes++; post.likedByMe = true;
                    userPoints += 2;
                    showToast("é€å‡ºæ„›å¿ƒï¼ç²å¾— 2 èƒ½é‡é»ï¼");
                }
                updatePointsUI();
                renderCanvas();
                checkBadges(); // æª¢æŸ¥äº’å‹•ç›¸é—œå‹³ç« 
            }
        }

        function addComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (text) {
                const post = sharedPosts.find(p => p.id === postId);
                if (post) {
                    post.comments.push({ author: "å°æ˜", text: text });
                    userPoints += 5;
                    updatePointsUI();
                    showToast("ç•™è¨€æˆåŠŸï¼ç²å¾— 5 èƒ½é‡é»ï¼");
                    renderCanvas();
                    checkBadges(); // æª¢æŸ¥äº’å‹•ç›¸é—œå‹³ç« 
                }
            }
        }

        // --- å…±ç”¨èˆ‡è¼”åŠ© ---
        function updatePointsUI() {
            const el = document.getElementById('user-points-display');
            if(el) {
                el.textContent = `ğŸª™ ${userPoints}`;
                el.classList.add('points-pop');
                setTimeout(() => el.classList.remove('points-pop'), 300);
            }
            
            // åŒæ™‚æ›´æ–°å€‹äººæª”æ¡ˆé é¢çš„é»æ•¸é¡¯ç¤º
            const profileEl = document.getElementById('profile-points-display');
            if(profileEl) profileEl.textContent = userPoints;
        }

        function addText(inputId, text) {
            const el = document.getElementById(inputId);
            el.value = (el.value.trim() !== '') ? el.value + '\n' + text : text;
        }

        function switchTab(tabName) {
            ['encourage', 'communicate', 'celebrate'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.remove('active', 'text-orange-600', 'border-orange-500');
                document.getElementById(`tab-${t}`).classList.add('text-gray-500');
                document.getElementById(`content-${t}`).classList.add('hidden-view');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active', 'text-orange-600', 'border-orange-500');
            document.getElementById(`tab-${tabName}`).classList.remove('text-gray-500');
            document.getElementById(`content-${tabName}`).classList.remove('hidden-view');
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => toast.classList.replace('opacity-100', 'opacity-0'), 2000);
        }
    </script>
</body>
</html>